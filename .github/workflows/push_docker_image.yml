name: Push Docker Image

on:
  push:
    tags:
      - v*

env:
  DOCKER_IMAGE: tapyrus/tapyrusd

jobs:
  prepare:
    if: ${{ github.repository == 'chaintope/tapyrus-core' }}
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.prep.outputs.version }}
      tags: ${{ steps.prep.outputs.tags }}
      created: ${{ steps.prep.outputs.created }}
    steps:
      - name: Prepare
        id: prep
        run: |
          VERSION=noop
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          elif [[ $GITHUB_REF == refs/heads/* ]]; then
            VERSION=$(echo ${GITHUB_REF#refs/heads/} | sed -r 's#/+#-#g')
            if [ "${{ github.event.repository.default_branch }}" = "$VERSION" ]; then
              VERSION=edge
            fi
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

  build-amd64:
    needs: prepare
    if: ${{ github.repository == 'chaintope/tapyrus-core' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push (amd64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}-amd64
          labels: |
            org.opencontainers.image.title=tapyrus-core
            org.opencontainers.image.description=Tapyrus Core
            org.opencontainers.image.url=https://github.com/chaintope/tapyrus-core
            org.opencontainers.image.source=https://github.com/chaintope/tapyrus-core.git
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.created=${{ needs.prepare.outputs.created }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha,scope=amd64
          cache-to: type=gha,mode=max,scope=amd64

  build-arm64:
    needs: prepare
    if: ${{ github.repository == 'chaintope/tapyrus-core' }}
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push (arm64)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: true
          tags: ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}-arm64
          labels: |
            org.opencontainers.image.title=tapyrus-core
            org.opencontainers.image.description=Tapyrus Core
            org.opencontainers.image.url=https://github.com/chaintope/tapyrus-core
            org.opencontainers.image.source=https://github.com/chaintope/tapyrus-core.git
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.created=${{ needs.prepare.outputs.created }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha,scope=arm64
          cache-to: type=gha,mode=max,scope=arm64

  merge-manifests:
    needs: [prepare, build-amd64, build-arm64]
    if: ${{ github.repository == 'chaintope/tapyrus-core' }}
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          VERSION=${{ needs.prepare.outputs.version }}
          docker buildx imagetools create -t ${DOCKER_IMAGE}:${VERSION} \
            ${DOCKER_IMAGE}:${VERSION}-amd64 \
            ${DOCKER_IMAGE}:${VERSION}-arm64

          # Add additional tags for release versions (e.g., v0.7.0 -> v0.7, v0, latest)
          if [[ $VERSION =~ ^v[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
            MINOR=${VERSION%.*}
            MAJOR=${MINOR%.*}
            docker buildx imagetools create -t ${DOCKER_IMAGE}:${MINOR} \
              ${DOCKER_IMAGE}:${VERSION}-amd64 \
              ${DOCKER_IMAGE}:${VERSION}-arm64
            docker buildx imagetools create -t ${DOCKER_IMAGE}:${MAJOR} \
              ${DOCKER_IMAGE}:${VERSION}-amd64 \
              ${DOCKER_IMAGE}:${VERSION}-arm64
            docker buildx imagetools create -t ${DOCKER_IMAGE}:latest \
              ${DOCKER_IMAGE}:${VERSION}-amd64 \
              ${DOCKER_IMAGE}:${VERSION}-arm64
          fi

  update-description:
    needs: merge-manifests
    if: ${{ github.repository == 'chaintope/tapyrus-core' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update repo description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
          repository: tapyrus/tapyrusd
          readme-filepath: ./doc/docker_image.md
